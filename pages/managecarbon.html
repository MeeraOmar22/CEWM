<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Carbon Management - Waste Management System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        /* Root Variables */
        :root {
            --primary: #0f371f;             /* Mint Green */
            --primary-light: #C8E6C9;       /* Lighter Mint */
            --bg-light: #F1FDF4;            /* Very light green background */
            --card-bg: #FFFFFF;
            --text-color: #2E7D32;          /* Deep Green */
            --radius: 8px;
            --transition: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-light);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--primary);
            color: #fff;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .sidebar .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
        }

        .sidebar nav ul {
            list-style: none;
        }

        .sidebar nav ul li {
            margin: 1rem 0;
        }

        .sidebar nav ul li a {
            text-decoration: none;
            color: #fff;
            font-weight: 600;
            display: block;
            padding: 10px;
            border-radius: var(--radius);
            transition: background var(--transition);
        }

        .sidebar nav ul li a:hover,
        .sidebar nav ul li a.active {
            background: var(--primary-light);
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Top Navbar */
        .topbar {
            background: #fff;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .topbar h1 {
            color: var(--text-color);
            font-size: 1.5rem;
        }

        /* Logout Button - Soft Red */
        #logout {
            background-color: #FFCDD2;
            color: #B71C1C;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition);
        }

        #logout:hover {
            background-color: #EF9A9A;
        }

        /* Content Header */
        .content-header {
            padding: 20px 30px;
        }

        .content-header h1 {
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
        }

        .content-header h1 i {
            margin-right: 10px;
            color: var(--primary);
        }

        /* Carbon Form Section */
        .carbon-form {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            padding: 25px;
            margin: 0 30px 30px;
            transition: transform var(--transition);
        }

        .carbon-form:hover {
            transform: translateY(-2px);
        }

        .carbon-form h2 {
            margin-bottom: 20px;
            font-weight: 700;
            color: var(--primary);
            font-size: 1.3rem;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 10px;
        }

        .carbon-form .section {
            margin-bottom: 30px;
        }

        .carbon-form .row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        /* New row with delete button styling */
        .row-with-delete {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--radius);
            border-left: 4px solid var(--primary-light);
            transition: all var(--transition);
        }

        .row-with-delete:hover {
            background: #f0f7f0;
            border-left-color: var(--primary);
        }

        .row-fields {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            flex: 1;
        }

        .carbon-form .field {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
        }

        .carbon-form .field label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .carbon-form .field input,
        .carbon-form .field select {
            padding: 12px;
            border: 2px solid #E0E0E0;
            border-radius: var(--radius);
            font-size: 14px;
            transition: border-color var(--transition);
        }

        .carbon-form .field input:focus,
        .carbon-form .field select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(15, 55, 31, 0.1);
        }

        .carbon-form .field input[readonly] {
            background-color: #f5f5f5;
            color: #666;
        }

        /* Buttons */
        .button-add,
        .button-action,
        .button-calculate {
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .button-add:hover,
        .button-action:hover,
        .button-calculate:hover {
            background: var(--text-color);
            transform: translateY(-1px);
        }

        .delete-button {
            background: #d32f2f;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
            margin-top: 25px; /* Align with input fields */
        }

        .delete-button:hover {
            background: #b71c1c;
            transform: translateY(-1px);
        }

        /* Scope 1 Container Specific Styles */
        #scope1-container .scope1-row:first-child {
            background: transparent;
            border-left: none;
            padding: 0;
        }

        #scope1-container .scope1-row:first-child:hover {
            background: transparent;
        }

        /* Add button styling improvements */
        .button-add {
            margin-top: 15px;
            margin-bottom: 10px;
        }

        /* Summary Section */
        .summary-section {
            background: linear-gradient(135deg, var(--primary-light), #E8F5E8);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 20px;
        }

        .summary-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        /* Action Buttons Container */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-start;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--primary-light);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .carbon-form .row {
                flex-direction: column;
            }
            
            .carbon-form .field {
                min-width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 15px;
            background: #fff;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            margin-top: auto;
        }

        /* Loading Animation */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Success Message */
        .success-message {
            background: #E8F5E8;
            color: var(--primary);
            padding: 10px 15px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }
    </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo"><i class="bx bx-recycle"></i> WMS Employee</div>
    <nav>
      <ul>
        <li><a href="employeeDashboard.html"><i class="bx bx-home"></i> Dashboard</a></li>
        <li><a href="wasteForm.html"><i class="bx bx-plus-circle"></i> Waste Form</a></li>
        <li><a href="managecarbon.html" class="active"><i class="bx bx-leaf"></i> Carbon Form</a></li>
        <li><a href="reportEmployee.html"><i class="bx bx-file"></i> Reports</a></li>
      </ul>
    </nav>
  </aside>

    <!-- Main Content -->
    <div class="main">
        <!-- Topbar -->
        <header class="topbar">
            <h1><i class="bx bx-leaf"></i> Manage Carbon Report</h1>
            <button id="logout">Logout</button>
        </header>

        <!-- Page Title -->
        <section class="content-header">

        </section>

        <!-- Carbon Form -->
        <section class="carbon-form">
            <div class="section">
                <h2><i class="bx bx-building"></i> Company Details</h2>
                <div class="row">
                    <div class="field">
                        <label for="reportDate">Report Date</label>
                        <input type="date" id="reportDate" required>
                    </div>
                    <div class="field">
                        <label for="reportId">Report ID</label>
                        <input type="text" id="reportId" value="AUTO12345" readonly>
                    </div>
                    <div class="field">
                        <label for="reportedBy">Reported By</label>
                        <input type="text" id="reportedBy" value="Employee Name" readonly>
                    </div>
                </div>
            </div>

            <!-- Scope 1 -->
            <div id="scope1-container" class="section">
                <h2><i class="bx bx-gas-pump"></i> Scope 1 Emissions Input</h2>
                <div class="row scope1-row">
                    <div class="field">
                        <label>Activity Type</label>
                        <select class="activity">
                            <option>Stationary Combustion</option>
                            <option>Mobile Combustion</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Fuel Type</label>
                        <select class="fuel-type">
                            <option value="diesel">Diesel</option>
                            <option value="petrol">Petrol</option>
                            <option value="natural_gas">Natural Gas</option>
                            <option value="lpg">LPG</option>
                            <option value="fuel_oil">Fuel Oil</option>
                            <option value="marine_gas_oil">Marine Gas Oil</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Amount Used (Liters)</label>
                        <input type="number" class="amount-used" min="0" step="0.01" placeholder="Enter amount">
                    </div>
                    <div class="field">
                        <label>Emissions (kgCO2e)</label>
                        <input type="text" class="emission-result" readonly value="0.00">
                    </div>
                </div>
                <button class="button-add" id="add-scope1-row">
                    <i class="bx bx-plus"></i> Add Another Field
                </button>
            </div>

            <!-- Scope 2 -->
            <div id="scope2-container" class="section">
                <h2><i class="bx bx-bolt"></i> Scope 2 Emissions Input</h2>
                <div class="row">
                    <div class="field">
                        <label>Port Region</label>
                        <select id="scope2-region">
                            <option>Port Klang (Selangor)</option>
                            <option>Penang Port (Penang)</option>
                            <option>Lumut Port (Perak)</option>
                            <option>Kuantan Port (Pahang)</option>
                            <option>Tanjung Pelepas (Johor)</option>
                            <option>Bintulu Port (Sarawak)</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Electricity Consumption (kWh)</label>
                        <input type="number" id="scope2-amount" min="0" step="0.01" placeholder="Enter kWh">
                    </div>
                    <div class="field">
                        <label>Emissions (kgCO2e)</label>
                        <input type="text" id="scope2-result" readonly value="0.00">
                    </div>
                </div>
                <!-- Remove the manual calculate button since it will be automatic -->
            </div>

            <!-- Summary Section -->
            <div class="summary-section">
                <h3><i class="bx bx-pie-chart-alt-2"></i> Emissions Summary</h3>
                <div class="row">
                    <div class="field">
                        <label>Scope 1 Emissions</label>
                        <input type="text" id="scope1-total" readonly value="0.00 kgCO2e">
                    </div>
                    <div class="field">
                        <label>Scope 2 Emissions</label>
                        <input type="text" id="scope2-total" readonly value="0.00 kgCO2e">
                    </div>
                    <div class="field">
                        <label>Total Emissions</label>
                        <input type="text" class="total-emissions" readonly value="0.00 kgCO2e">
                    </div>
                </div>
                <div class="row">
                    <div class="field">
                        <label>Scope 1 Percentage</label>
                        <input type="text" id="scope1-percentage" readonly value="0%">
                    </div>
                    <div class="field">
                        <label>Scope 2 Percentage</label>
                        <input type="text" id="scope2-percentage" readonly value="0%">
                    </div>
                    <div class="field">
                        <label>Report Status</label>
                        <input type="text" id="report-status" readonly value="Draft">
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="button-action" onclick="window.location.href='employeeDashboard.html'">
                    <i class="bx bx-arrow-back"></i> Back to Dashboard
                </button>
                <button class="button-action" onclick="saveReport()" style="background: #4CAF50;">
                    <i class="bx bx-save"></i> Save Report
                </button>
            </div>
        </section>

        <!-- Footer -->
        <footer>
            <p>&copy; 2025 Waste Management System | Carbon Emissions Tracking</p>
        </footer>
    </div>

    <!-- Firebase and Auth Scripts -->
    <script type="module">
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
        import { app } from "../js/firebase-config.js";

        const auth = getAuth(app);

        // Logout functionality
        document.getElementById("logout").addEventListener("click", async () => {
            try {
                await signOut(auth);
                console.log("User signed out successfully.");
                localStorage.removeItem("loggedInUserId");
                window.location.href = "index.html";
            } catch (error) {
                console.error("Logout failed:", error.message);
                alert("Error logging out. Please try again.");
            }
        });

        // Check authentication
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                document.getElementById("reportedBy").value = user.email || "Employee";
            } else {
                // Not logged in
                window.location.href = "index.html";
            }
        });

        // Auto-calculate Scope 2 functionality
        window.calculateScope2 = function() {
            const amount = parseFloat(document.getElementById("scope2-amount").value) || 0;
            const emissionFactor = 0.708; // kg CO2e per kWh (Malaysia grid average)
            const result = (amount * emissionFactor).toFixed(2);
            document.getElementById("scope2-result").value = result;
            updateSummary();
        };

        // Auto-calculate Scope 1 functionality
        function calculateScope1Emission(row) {
            const amountInput = row.querySelector('.amount-used');
            const fuelTypeSelect = row.querySelector('.fuel-type');
            const resultInput = row.querySelector('.emission-result');
            
            if (!amountInput || !fuelTypeSelect || !resultInput) return;
            
            const amount = parseFloat(amountInput.value) || 0;
            const fuelType = fuelTypeSelect.value;
            
            // Emission factors (kg CO2e per liter)
            const emissionFactors = {
                diesel: 2.68,
                petrol: 2.31,
                natural_gas: 1.87,
                lpg: 1.51,
                fuel_oil: 3.15,
                marine_gas_oil: 3.20
            };
            
            const factor = emissionFactors[fuelType] || 0;
            const result = (amount * factor).toFixed(2);
            resultInput.value = result;
            
            updateSummary();
        }

        window.saveReport = async function() {
            try {
                // Import Firestore functions
                const { getFirestore, collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js");
                const db = getFirestore(app);

                // Get current user
                const user = auth.currentUser;
                if (!user) {
                    alert("You must be logged in to save a report.");
                    return;
                }

                // Collect company details
                const reportData = {
                    reportDate: document.getElementById("reportDate").value,
                    reportId: document.getElementById("reportId").value,
                    reportedBy: document.getElementById("reportedBy").value,
                    userId: user.uid,
                    userEmail: user.email,
                    
                    // Collect all Scope 1 emissions data
                    scope1Emissions: [],
                    
                    // Collect Scope 2 emissions data
                    scope2Emissions: {
                        region: document.getElementById("scope2-region").value,
                        electricityConsumption: parseFloat(document.getElementById("scope2-amount").value) || 0,
                        emissions: parseFloat(document.getElementById("scope2-result").value) || 0
                    },
                    
                    // Summary data
                    summary: {
                        scope1Total: parseFloat(document.getElementById("scope1-total").value.replace(" kgCO2e", "")) || 0,
                        scope2Total: parseFloat(document.getElementById("scope2-total").value.replace(" kgCO2e", "")) || 0,
                        totalEmissions: parseFloat(document.querySelector(".total-emissions").value.replace(" kgCO2e", "")) || 0,
                        scope1Percentage: document.getElementById("scope1-percentage").value,
                        scope2Percentage: document.getElementById("scope2-percentage").value
                    },
                    
                    // Metadata
                    status: document.getElementById("report-status").value,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    reportType: "carbon_emissions"
                };

                // Collect all Scope 1 data from all rows
                const scope1Rows = document.querySelectorAll('#scope1-container .scope1-row');
                scope1Rows.forEach((row, index) => {
                    const activity = row.querySelector('.activity')?.value;
                    const fuelType = row.querySelector('.fuel-type')?.value;
                    const amountUsed = parseFloat(row.querySelector('.amount-used')?.value) || 0;
                    const emissions = parseFloat(row.querySelector('.emission-result')?.value) || 0;
                    
                    // Only add rows with data
                    if (amountUsed > 0 || emissions > 0) {
                        reportData.scope1Emissions.push({
                            rowIndex: index + 1,
                            activity: activity,
                            fuelType: fuelType,
                            amountUsed: amountUsed,
                            emissions: emissions,
                            unit: "liters"
                        });
                    }
                });

                // Validate required fields
                if (!reportData.reportDate) {
                    alert("Please select a report date.");
                    return;
                }

                if (reportData.scope1Emissions.length === 0 && reportData.scope2Emissions.electricityConsumption === 0) {
                    alert("Please enter at least one emission source (Scope 1 or Scope 2) before saving.");
                    return;
                }

                // Show loading state
                const saveButton = document.querySelector('button[onclick="saveReport()"]');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Saving...';
                saveButton.disabled = true;

                // Save to Firestore
                const docRef = await addDoc(collection(db, "carbonReports"), reportData);
                
                // Update report status to "Submitted"
                document.getElementById("report-status").value = "Submitted";
                
                // Success notification
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.innerHTML = `
                    <i class="bx bx-check-circle"></i> 
                    Report saved successfully! Document ID: ${docRef.id}
                `;
                
                // Insert success message before the form
                const carbonForm = document.querySelector('.carbon-form');
                carbonForm.parentNode.insertBefore(successMsg, carbonForm);
                
                // Remove success message after 5 seconds
                setTimeout(() => {
                    successMsg.remove();
                }, 5000);

                console.log("Carbon report saved with ID: ", docRef.id);

            } catch (error) {
                console.error("Error saving carbon report: ", error);
                alert(`Error saving report: ${error.message}`);
            } finally {
                // Restore button state
                const saveButton = document.querySelector('button[onclick="saveReport()"]');
                if (saveButton) {
                    saveButton.innerHTML = '<i class="bx bx-save"></i> Save Report';
                    saveButton.disabled = false;
                }
            }
        };

        function updateSummary() {
            // Calculate total Scope 1 emissions
            let scope1Total = 0;
            const scope1Rows = document.querySelectorAll('#scope1-container .scope1-row');
            scope1Rows.forEach(row => {
                const result = parseFloat(row.querySelector('.emission-result').value) || 0;
                scope1Total += result;
            });
            
            const scope2Total = parseFloat(document.getElementById("scope2-result").value) || 0;
            const total = scope1Total + scope2Total;

            document.getElementById("scope1-total").value = scope1Total.toFixed(2) + " kgCO2e";
            document.getElementById("scope2-total").value = scope2Total.toFixed(2) + " kgCO2e";
            document.querySelector(".total-emissions").value = total.toFixed(2) + " kgCO2e";

            // Calculate percentages
            if (total > 0) {
                const scope1Percent = ((scope1Total / total) * 100).toFixed(1);
                const scope2Percent = ((scope2Total / total) * 100).toFixed(1);
                document.getElementById("scope1-percentage").value = scope1Percent + "%";
                document.getElementById("scope2-percentage").value = scope2Percent + "%";
            } else {
                document.getElementById("scope1-percentage").value = "0%";
                document.getElementById("scope2-percentage").value = "0%";
            }
        }

        // Set up auto-calculation for Scope 1
        function setupScope1AutoCalculation() {
            const scope1Rows = document.querySelectorAll('#scope1-container .scope1-row');
            scope1Rows.forEach(row => {
                const amountInput = row.querySelector('.amount-used');
                const fuelTypeSelect = row.querySelector('.fuel-type');
                
                if (amountInput && !amountInput.hasAttribute('data-listener-added')) {
                    amountInput.addEventListener('input', () => calculateScope1Emission(row));
                    amountInput.addEventListener('change', () => calculateScope1Emission(row));
                    amountInput.setAttribute('data-listener-added', 'true');
                }
                
                if (fuelTypeSelect && !fuelTypeSelect.hasAttribute('data-listener-added')) {
                    fuelTypeSelect.addEventListener('change', () => calculateScope1Emission(row));
                    fuelTypeSelect.setAttribute('data-listener-added', 'true');
                }
            });
        }

        // Set up auto-calculation for Scope 2
        function setupScope2AutoCalculation() {
            const scope2Input = document.getElementById("scope2-amount");
            if (scope2Input) {
                scope2Input.addEventListener('input', calculateScope2);
                scope2Input.addEventListener('change', calculateScope2);
            }
        }

        // Add new Scope 1 row functionality (simplified version)
        window.addScope1Row = function() {
            const container = document.getElementById('scope1-container');
            const addButton = document.getElementById('add-scope1-row');
            
            // Create new row element
            const newRow = document.createElement('div');
            newRow.className = 'row-with-delete scope1-row';
            newRow.innerHTML = `
                <div class="row-fields">
                    <div class="field">
                        <label>Activity Type</label>
                        <select class="activity">
                            <option>Stationary Combustion</option>
                            <option>Mobile Combustion</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Fuel Type</label>
                        <select class="fuel-type">
                            <option value="diesel">Diesel</option>
                            <option value="petrol">Petrol</option>
                            <option value="natural_gas">Natural Gas</option>
                            <option value="lpg">LPG</option>
                            <option value="fuel_oil">Fuel Oil</option>
                            <option value="marine_gas_oil">Marine Gas Oil</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Amount Used (Liters)</label>
                        <input type="number" class="amount-used" min="0" step="0.01" placeholder="Enter amount">
                    </div>
                    <div class="field">
                        <label>Emissions (kgCO2e)</label>
                        <input type="text" class="emission-result" readonly value="0.00">
                    </div>
                </div>
                <button class="delete-button" type="button" title="Delete this row">×</button>
            `;
            
            // Insert before the add button
            container.insertBefore(newRow, addButton);
            
            // Add event listeners to the new row
            const amountInput = newRow.querySelector('.amount-used');
            const fuelTypeSelect = newRow.querySelector('.fuel-type');
            const deleteButton = newRow.querySelector('.delete-button');
            
            amountInput.addEventListener('input', () => calculateScope1Emission(newRow));
            amountInput.addEventListener('change', () => calculateScope1Emission(newRow));
            fuelTypeSelect.addEventListener('change', () => calculateScope1Emission(newRow));
            deleteButton.addEventListener('click', () => {
                newRow.remove();
                updateSummary();
            });
        };

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            document.getElementById("reportDate").valueAsDate = new Date();
            
            // Set up auto-calculation for both Scope 1 and Scope 2
            setupScope1AutoCalculation();
            setupScope2AutoCalculation();
            
            // Set up the add button for Scope 1
            const addButton = document.getElementById('add-scope1-row');
            if (addButton) {
                addButton.addEventListener('click', addScope1Row);
            }
        });
    </script>

</body>
</html>
